version: "3.8"

services:
  android-builder:
    build: .
    volumes:
      # Mount the source code
      - ./app:/app:ro
      # Output volume for build artifacts
      - android-builds:/app/build-output
      # Cache volume for Gradle dependencies
      - gradle-cache:/root/.gradle
      # Cache volume for npm dependencies
      - npm-cache:/root/.npm
    environment:
      - GRADLE_OPTS=-Dorg.gradle.daemon=false
    command: >
      sh -c "
        echo 'Starting Android build process...' &&
        mkdir -p /app/build-output &&
        cd /app &&
        ./build.sh &&
        echo 'Copying build artifacts to output volume...' &&
        cp -r android/app/build/outputs/apk/debug/* /app/build-output/ 2>/dev/null || true &&
        cp -r android/app/build/outputs/apk/release/* /app/build-output/ 2>/dev/null || true &&
        echo 'Build artifacts copied to /app/build-output/' &&
        ls -la /app/build-output/
      "

volumes:
  android-builds:
    driver: local
  gradle-cache:
    driver: local
  npm-cache:
    driver: local
